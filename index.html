<!DOCTYPE html>
<html>

<head>
  <style>
    .nice_button {
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 8px;
    }
  </style>
  <script>
    var ctx;
    var pos;
    var change = true;

    function activate_canvas() {
      // create canvas element and append it to document body
      var canvas = document.getElementById("myCanvas");
      
      // get canvas 2D context and set him correct size
      ctx = canvas.getContext('2d');
      resize();

      // last known position
      pos = { x: 0, y: 0 };

      window.addEventListener('resize', resize);
      document.addEventListener('mousemove', draw);
      document.addEventListener('mousedown', setPosition);
      document.addEventListener('mouseenter', setPosition);
    }
    

    // new position from mouse event
    function setPosition(e) {
      pos.x = e.clientX -= ctx.canvas.getBoundingClientRect().x;
      pos.y = e.clientY -= ctx.canvas.getBoundingClientRect().y;
    }

    // resize canvas
    function resize() {
      ctx.canvas.width = 400;
      ctx.canvas.height = 400;
    }

    function draw(e) {
      // mouse left button must be pressed
      if (e.buttons !== 1) return;

      ctx.beginPath(); // begin

      ctx.lineWidth = 20; //TODO - reduce
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000000';

      ctx.moveTo(pos.x, pos.y); // from
      setPosition(e);
      ctx.lineTo(pos.x, pos.y); // to

      ctx.stroke(); // draw it!
      change = true;
    }

    function get_pred(responseText) {
      console.log(responseText);
    }

    function send_image() {
      if (change) {
        var dataURL = ctx.canvas.toDataURL();
        var request = new XMLHttpRequest();
        request.open("POST", '/upload_image');
        request.setRequestHeader("Content-Type", "application/json")
        request.onload = function () {
          get_pred(request.responseText)
        }
        request.onerror = function () { }
        data = {"imageBase64": dataURL}
        request.send(JSON.stringify(data));
        change = false;
      }
     
    }
    setInterval(send_image, 100);

    function clear_canvas() {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    }
  </script>
</head>

<body>
  <h1 style="text-align: center;">AI Pictionary</h1>
  <canvas id="myCanvas" style="border: 1px solid black; padding: 0; margin: auto; display: block;"></canvas>
  
  <div style="text-align: center;">
    <button onclick="clear_canvas()" class="nice_button" style="background-color: red">Clear!</button>
  </div>
  <script>
    activate_canvas();
  </script>

</body>

</html>